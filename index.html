<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Interview Simulator</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 860px; margin: 40px auto; padding: 20px; }
    h1 { text-align: center; }
    label { font-weight: bold; }
    input, textarea { width: 100%; padding: 8px; margin: 8px 0; box-sizing: border-box; }
    button { padding: 10px 16px; font-size: 16px; margin-top: 10px; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    #timer { font-size: 18px; font-weight: bold; text-align: right; margin: 10px 0; }
    #question { font-size: 20px; margin: 22px 0; padding: 18px; background: #f0f0f0; border-radius: 8px; }
    #result { text-align: center; }
    .hidden { display: none; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    .row button { flex: 1 1 200px; }
    .hint { color: #555; margin-top: 6px; font-size: 14px; }
    .status { margin-top: 8px; font-size: 14px; }
    #answer { resize: vertical; }
    #transcript-wrap { text-align: left; margin-top: 22px; }
    .qa { border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin: 12px 0; }
    .qa .q { font-weight: bold; margin-bottom: 8px; }
    .qa .a { white-space: pre-wrap; }
    .qa .w { margin-top: 8px; color: #666; font-size: 14px; }
    .smallbtn { font-size: 14px; padding: 8px 12px; }
    .danger { color: red; }
    .pill { display: inline-block; padding: 3px 8px; border-radius: 999px; background: #eee; font-size: 12px; }
  </style>
</head>
<body>
  <h1>AI Interview Simulator</h1>

  <div id="start-form">
    <label>1) Interview Type (job, school, campâ€¦):</label><br />
    <input id="int-type" type="text" /><br /><br />

    <label>2) Paste your resume / profile:</label><br />
    <textarea id="resume" rows="10"></textarea><br /><br />

    <label>3) Interview duration (minutes):</label><br />
    <input id="duration" type="number" min="1" value="10" /><br /><br />

    <p class="hint">
      This interview uses your microphone (speech-to-text). On most browsers it requires HTTPS
      (or <code>http://localhost</code>) and microphone permission.
      <br />
      <span class="pill">AI-generated voice</span>
      The interviewer voice you hear is generated by AI. <!-- required disclosure per OpenAI TTS guide :contentReference[oaicite:5]{index=5} -->
    </p>

    <button onclick="startInterview()">Start Interview</button>
  </div>

  <div id="interview" class="hidden">
    <div id="timer">Time left: --:--</div>
    <div id="question"></div>

    <div class="row">
      <button id="btn-record" onclick="startRecording()">ðŸŽ¤ Start speaking</button>
      <button id="btn-stop" onclick="stopRecording()" disabled>Stop</button>
      <button id="btn-clear" class="smallbtn" onclick="clearAnswer()" disabled>Clear</button>
    </div>

    <div id="rec-status" class="status"></div>

    <label>Your spoken answer (auto-transcribed):</label>
    <textarea id="answer" rows="6" readonly placeholder="Your words will appear here..."></textarea><br />
    <button id="btn-submit" onclick="submitAnswer()" disabled>Submit Answer</button>

    <p class="hint">
      Tip: If the transcription looks wrong, press <b>Clear</b> and record again.
    </p>
  </div>

  <div id="result" class="hidden">
    <h2>Interview Complete</h2>
    <p id="result-status" style="font-size: 24px; font-weight: bold;"></p>
    <p id="result-conf" style="font-size: 18px;"></p>
    <p id="result-reason" style="color: red; font-size: 18px;"></p>

    <div id="transcript-wrap" class="hidden">
      <h3>Transcript & Transcriptions</h3>
      <button class="smallbtn" onclick="copyTranscript()">Copy transcript</button>
      <div id="transcript"></div>
    </div>
  </div>

  <script>
    let durationSeconds = 0;
    let timerInterval = null;

    let timeIsUp = false;
    let currentQuestionActive = false;

    let recognition = null;
    let isRecording = false;
    let finalTranscript = "";

    // ---- OpenAI TTS playback state ----
    let ttsAudio = null;
    let ttsObjectUrl = null;

    function stopTTS() {
      try {
        if (ttsAudio) {
          ttsAudio.pause();
          ttsAudio.currentTime = 0;
        }
      } catch {}
      if (ttsObjectUrl) {
        URL.revokeObjectURL(ttsObjectUrl);
        ttsObjectUrl = null;
      }
      ttsAudio = null;
    }

    async function speak(text) {
      stopTTS();

      // Small â€œhumanâ€ pause
      await new Promise(r => setTimeout(r, 250));

      try {
        const resp = await fetch('/api/tts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });

        if (!resp.ok) throw new Error(`TTS HTTP ${resp.status}`);

        const buf = await resp.arrayBuffer();
        const blob = new Blob([buf], { type: 'audio/mpeg' });

        ttsObjectUrl = URL.createObjectURL(blob);
        ttsAudio = new Audio(ttsObjectUrl);

        // Let the user start speaking without fighting the audio
        ttsAudio.onended = () => stopTTS();
        ttsAudio.onerror = () => stopTTS();

        await ttsAudio.play();
      } catch (e) {
        console.warn('OpenAI TTS failed:', e);
        // If TTS fails, we just silently skip speaking.
      }
    }

    function getSpeechRecognition() {
      return window.SpeechRecognition || window.webkitSpeechRecognition || null;
    }

    async function startInterview() {
      const type = document.getElementById('int-type').value.trim();
      const resume = document.getElementById('resume').value.trim();
      const dur = Number(document.getElementById('duration').value);

      if (!type || !resume || !dur || dur <= 0) {
        alert('Please fill all fields correctly.');
        return;
      }

      const SR = getSpeechRecognition();
      if (!SR) {
        alert('Speech recognition is not supported in this browser. Try Chrome/Edge, or use a device with Web Speech API.');
        return;
      }

      recognition = new SR();
      recognition.lang = 'en-US';
      recognition.interimResults = true;
      recognition.continuous = true;

      recognition.onresult = (event) => {
        let interim = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const res = event.results[i];
          const text = res[0]?.transcript || '';
          if (res.isFinal) finalTranscript += text + ' ';
          else interim += text;
        }
        document.getElementById('answer').value = (finalTranscript + interim).trim();
        updateControls();
      };

      recognition.onerror = (e) => {
        isRecording = false;
        updateControls();
        document.getElementById('rec-status').innerHTML =
          `<span class="danger">Mic error:</span> ${e.error || 'unknown error'} (check permissions)`;
      };

      recognition.onend = () => {
        isRecording = false;
        updateControls();
        if (document.getElementById('answer').value.trim()) {
          document.getElementById('rec-status').textContent = 'Stopped (ready to submit).';
        } else {
          document.getElementById('rec-status').textContent = '';
        }
      };

      const resp = await fetch('/api/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type, resume, duration: dur })
      });

      if (!resp.ok) {
        alert('Failed to start interview');
        return;
      }

      durationSeconds = Math.floor(dur * 60);
      timeIsUp = false;
      currentQuestionActive = false;

      document.getElementById('start-form').classList.add('hidden');
      document.getElementById('interview').classList.remove('hidden');

      clearAnswer();
      startTimer();
      getNextQuestion();
    }

    function startTimer() {
      const timerEl = document.getElementById('timer');
      let remaining = durationSeconds;

      const paint = () => {
        if (timeIsUp) {
          timerEl.textContent = 'Overtime';
          timerEl.style.color = 'red';
          return;
        }
        const m = Math.floor(remaining / 60);
        const s = remaining % 60;
        timerEl.textContent = `Time left: ${m}:${s.toString().padStart(2, '0')}`;

        if (remaining <= 10) timerEl.style.color = 'red';
        else if (remaining <= 30) timerEl.style.color = 'orange';
        else timerEl.style.color = 'black';
      };

      paint();
      timerInterval = setInterval(() => {
        remaining--;
        if (remaining <= 0) {
          remaining = 0;
          clearInterval(timerInterval);

          timeIsUp = true;
          paint();

          if (!currentQuestionActive) finishInterview();
          return;
        }
        paint();
      }, 1000);
    }

    async function getNextQuestion() {
      if (timeIsUp) {
        finishInterview();
        return;
      }

      safeStopRecording();
      stopTTS();

      const resp = await fetch('/api/next-question');
      const data = await resp.json();

      if (data.end) {
        finishInterview();
        return;
      }
      if (!data.question) {
        alert('Error getting question');
        return;
      }

      document.getElementById('question').textContent = data.question;
      currentQuestionActive = true;

      clearAnswer();
      document.getElementById('rec-status').textContent = '';
      updateControls();

      // Speak the question with OpenAI TTS
      speak(data.question);
    }

    function startRecording() {
      if (!recognition) return;

      // If the question audio is playing, stop it so it doesn't get picked up.
      stopTTS();

      if (!document.getElementById('answer').value.trim()) finalTranscript = '';

      try {
        isRecording = true;
        document.getElementById('rec-status').textContent = 'Listeningâ€¦ (speak your answer)';
        recognition.start();
        updateControls();
      } catch (e) {
        isRecording = false;
        updateControls();
      }
    }

    function stopRecording() {
      if (!recognition) return;
      safeStopRecording();
      updateControls();
    }

    function safeStopRecording() {
      if (!recognition) return;
      if (!isRecording) return;
      try { recognition.stop(); } catch {}
      isRecording = false;
    }

    function clearAnswer() {
      finalTranscript = '';
      document.getElementById('answer').value = '';
      document.getElementById('rec-status').textContent = '';
      updateControls();
    }

    function updateControls() {
      const hasText = !!document.getElementById('answer').value.trim();

      document.getElementById('btn-record').disabled = !currentQuestionActive || isRecording;
      document.getElementById('btn-stop').disabled = !isRecording;
      document.getElementById('btn-clear').disabled = !currentQuestionActive || isRecording || !hasText;
      document.getElementById('btn-submit').disabled = !currentQuestionActive || isRecording || !hasText;
    }

    async function submitAnswer() {
      if (!currentQuestionActive) return;

      safeStopRecording();

      const answer = document.getElementById('answer').value.trim();
      if (!answer) {
        alert('Please speak an answer first.');
        return;
      }

      document.getElementById('btn-submit').disabled = true;

      const resp = await fetch('/api/submit-answer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ answer })
      });

      const data = await resp.json();

      currentQuestionActive = false;
      updateControls();

      if (timeIsUp || data.time_up) {
        finishInterview();
      } else {
        getNextQuestion();
      }
    }

    async function finishInterview() {
      safeStopRecording();
      stopTTS();
      if (timerInterval) clearInterval(timerInterval);

      document.getElementById('interview').classList.add('hidden');
      document.getElementById('result').classList.remove('hidden');

      const resp = await fetch('/api/result');
      const data = await resp.json();

      document.getElementById('result-status').textContent = `Result: ${data.status || 'Fail'}`;
      document.getElementById('result-conf').textContent = `Confidence: ${data.confidence || 0}%`;
      if (data.status === 'Fail' && data.reason) {
        document.getElementById('result-reason').textContent = `Reason: ${data.reason}`;
      } else {
        document.getElementById('result-reason').textContent = '';
      }

      if (Array.isArray(data.history) && data.history.length) {
        renderTranscript(data.history);
      } else {
        try {
          const tr = await fetch('/api/transcript');
          const trData = await tr.json();
          if (Array.isArray(trData.history) && trData.history.length) {
            renderTranscript(trData.history);
          }
        } catch {}
      }
    }

    function renderTranscript(history) {
      const wrap = document.getElementById('transcript-wrap');
      const el = document.getElementById('transcript');

      el.innerHTML = history.map((h, idx) => {
        const q = escapeHtml(h.question || '');
        const a = escapeHtml(h.answer || '');
        const w = escapeHtml(h.weakness || '');
        return `
          <div class="qa">
            <div class="q">${idx + 1}. Q: ${q}</div>
            <div class="a"><b>Transcription:</b>\n${a}</div>
            ${w ? `<div class="w"><b>Note:</b> ${w}</div>` : ``}
          </div>
        `;
      }).join('');

      wrap.classList.remove('hidden');
    }

    function copyTranscript() {
      const items = Array.from(document.querySelectorAll('#transcript .qa'));
      const text = items.map((box) => box.innerText).join('\n\n---\n\n');
      navigator.clipboard?.writeText(text).then(() => {
        alert('Transcript copied to clipboard.');
      }).catch(() => {
        alert('Could not copy. Select and copy manually.');
      });
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }
  </script>
</body>
</html>
